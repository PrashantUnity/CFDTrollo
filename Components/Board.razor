@using CFDTrollo.Models
@using CFDTrollo.Data
@using CFDTrollo.Services
@inject LocalStorageService LocalStorage
@inject IJSRuntime JSRuntime
@inject DragDropService DragDropService
@implements IDisposable

<div class="min-h-screen bg-board">
    <main class="p-6 md:p-8 overflow-x-auto">
        <div id="board-lists" class="board-container flex gap-4 md:gap-6 items-start min-h-[200px] pb-4 w-max" @ref="boardListsElement" data-board-id="main-board">
            @foreach (var (list, index) in boardState.Lists.Select((list, index) => (list, index)))
            {
                <ListComponent List="@list" 
                               Index="@index" 
                               OnAddCard="@((title) => HandleAddCard(list.Id, title))" 
                               OnUpdateCard="@HandleUpdateCard"
                               OnDeleteList="@(() => HandleDeleteList(list.Id))"
                               OnDeleteCard="@HandleDeleteCard" />
            }
        </div>
    </main>
    
    <!-- Horizontal line at bottom -->
    <div class="border-t border-border/50 mx-4"></div>

    <!-- Floating Add List Button - Bottom Right -->
    <button @onclick="HandleQuickAddList"
            class="fixed bottom-6 right-6 bg-primary hover:bg-primary/90 text-primary-foreground rounded-full p-4 shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center w-14 h-14 z-50"
            title="Add New List">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
    </button>
    
    <!-- Test Button -->
    <button @onclick="TestDragDrop"
            class="fixed bottom-6 right-24 bg-green-600 hover:bg-green-700 text-white rounded-full p-4 shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center w-14 h-14 z-50"
            title="Test Drag Drop">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
    </button>
</div>

@code {
    [Parameter] public string WorkspaceId { get; set; } = "default";
    [Parameter] public EventCallback<int> OnCardCountChanged { get; set; }

    private BoardState boardState = new();
    private DotNetObjectReference<Board>? dotNetReference;
    private ElementReference boardListsElement;

    protected override async Task OnInitializedAsync()
    {
        await LoadBoardState();
        dotNetReference = DotNetObjectReference.Create(this);
        await DragDropService.InitializeDragDropAsync(dotNetReference);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Enable list dragging on the board
            await DragDropService.EnableListDraggingAsync(boardListsElement);
        }
    }

    private async Task LoadBoardState()
    {
        var storageKey = GetStorageKey(WorkspaceId);
        var savedState = await LocalStorage.GetItem<BoardState>(storageKey);
        
        if (savedState != null && savedState.Lists.Any())
        {
            boardState = savedState;
            Console.WriteLine($"Board state loaded from localStorage with key: {storageKey}");
        }
        else
        {
            boardState = InitialBoardState.GetInitialState();
            Console.WriteLine($"No saved state found, using initial state for key: {storageKey}");
        }
    }

    private async Task SaveBoardState()
    {
        if (boardState.Lists.Any())
        {
            var storageKey = GetStorageKey(WorkspaceId);
            await LocalStorage.SetItem(storageKey, boardState);
            await NotifyCardCountChanged();
            Console.WriteLine($"Board state saved to localStorage with key: {storageKey}");
        }
    }

    private async Task NotifyCardCountChanged()
    {
        var totalCards = boardState.Lists.Sum(list => list.Cards.Count);
        await OnCardCountChanged.InvokeAsync(totalCards);
    }

    private string GetStorageKey(string workspaceId) => $"project-board-state-{workspaceId}";

    private void HandleAddCard(string listId, string title)
    {
        var list = boardState.Lists.FirstOrDefault(l => l.Id == listId);
        if (list != null)
        {
            var newCard = new Card
            {
                Id = $"card-{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}",
                Title = title
            };
            list.Cards.Add(newCard);
            StateHasChanged();
            _ = SaveBoardState();
        }
    }

    private void HandleUpdateCard(Card updatedCard)
    {
        foreach (var list in boardState.Lists)
        {
            var cardIndex = list.Cards.FindIndex(c => c.Id == updatedCard.Id);
            if (cardIndex >= 0)
            {
                list.Cards[cardIndex] = updatedCard;
                break;
            }
        }
        StateHasChanged();
        _ = SaveBoardState();
    }

    private void HandleQuickAddList()
    {
        var newList = new List
        {
            Id = $"list-{DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()}",
            Title = $"New List {boardState.Lists.Count + 1}",
            Cards = new List<Card>()
        };

        boardState.Lists.Add(newList);
        StateHasChanged();
        _ = SaveBoardState();
    }

    private async Task HandleDeleteList(string listId)
    {
        var list = boardState.Lists.FirstOrDefault(l => l.Id == listId);
        if (list == null) return;

        // Show confirmation dialog
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete the list '{list.Title}'? This will also delete all {list.Cards.Count} cards in this list.");

        if (confirmed)
        {
            boardState.Lists.Remove(list);
            StateHasChanged();
            await SaveBoardState();
        }
    }

    private async Task HandleDeleteCard(string cardId)
    {
        // Find the card in all lists
        Card? cardToDelete = null;
        List? parentList = null;

        foreach (var list in boardState.Lists)
        {
            var card = list.Cards.FirstOrDefault(c => c.Id == cardId);
            if (card != null)
            {
                cardToDelete = card;
                parentList = list;
                break;
            }
        }

        if (cardToDelete == null || parentList == null) return;

        // Show confirmation dialog
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete the card '{cardToDelete.Title}'?");

        if (confirmed)
        {
            parentList.Cards.Remove(cardToDelete);
            StateHasChanged();
            await SaveBoardState();
        }
    }

    [JSInvokable]
    public async Task HandleCardMove(string cardId, string sourceListId, string targetListId, int newIndex)
    {
        try
        {
            Console.WriteLine($"üéØ HandleCardMove called: cardId={cardId}, sourceListId={sourceListId}, targetListId={targetListId}, newIndex={newIndex}");
            
            // Find source and target lists
            var sourceList = boardState.Lists.FirstOrDefault(l => l.Id == sourceListId);
            var targetList = boardState.Lists.FirstOrDefault(l => l.Id == targetListId);

            if (sourceList == null || targetList == null) return;

            // Find the card to move
            var card = sourceList.Cards.FirstOrDefault(c => c.Id == cardId);
            if (card == null) return;

            // Remove from source list
            sourceList.Cards.Remove(card);

            // Add to target list at the correct position
            if (newIndex >= 0 && newIndex <= targetList.Cards.Count)
            {
                targetList.Cards.Insert(newIndex, card);
            }
            else
            {
                targetList.Cards.Add(card);
            }

            StateHasChanged();
            await SaveBoardState();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling card move: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task HandleCardReorder(string cardId, string listId, int oldIndex, int newIndex)
    {
        try
        {
            Console.WriteLine($"üéØ HandleCardReorder called: cardId={cardId}, listId={listId}, oldIndex={oldIndex}, newIndex={newIndex}");
            
            var list = boardState.Lists.FirstOrDefault(l => l.Id == listId);
            if (list == null) return;

            // Reorder within the same list
            if (oldIndex >= 0 && oldIndex < list.Cards.Count && newIndex >= 0 && newIndex < list.Cards.Count)
            {
                var card = list.Cards[oldIndex];
                list.Cards.RemoveAt(oldIndex);
                list.Cards.Insert(newIndex, card);
            }

            StateHasChanged();
            await SaveBoardState();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling card reorder: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task HandleListReorder(string listId, int oldIndex, int newIndex)
    {
        try
        {
            Console.WriteLine($"üéØ HandleListReorder called: listId={listId}, oldIndex={oldIndex}, newIndex={newIndex}");
            
            // Reorder lists
            if (oldIndex >= 0 && oldIndex < boardState.Lists.Count && newIndex >= 0 && newIndex < boardState.Lists.Count)
            {
                var list = boardState.Lists[oldIndex];
                boardState.Lists.RemoveAt(oldIndex);
                boardState.Lists.Insert(newIndex, list);
            }

            StateHasChanged();
            await SaveBoardState();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling list reorder: {ex.Message}");
        }
    }

    private async Task TestDragDrop()
    {
        Console.WriteLine("üß™ Testing drag drop...");
        
        try
        {
            // Test if dragDrop is available
            var dragDropExists = await JSRuntime.InvokeAsync<bool>("eval", "typeof window.dragDrop !== 'undefined'");
            Console.WriteLine($"üîç dragDrop exists: {dragDropExists}");
            
            if (dragDropExists)
            {
                // Test the dragDrop object
                var dragDropMethods = await JSRuntime.InvokeAsync<string>("eval", "Object.keys(window.dragDrop).join(', ')");
                Console.WriteLine($"üîß dragDrop methods: {dragDropMethods}");
                
                // Test the test function
                await JSRuntime.InvokeVoidAsync("eval", "if (typeof window.testDragDrop === 'function') { window.testDragDrop(); } else { console.log('‚ùå testDragDrop function not found'); }");
                
                // Test initialization
                await DragDropService.InitializeDragDropAsync(dotNetReference);
                Console.WriteLine("‚úÖ Drag drop test completed successfully");
                
                // Test enabling drag on first card
                if (boardState.Lists.Any() && boardState.Lists.First().Cards.Any())
                {
                    var firstCard = boardState.Lists.First().Cards.First();
                    Console.WriteLine($"üîß Testing card drag for: {firstCard.Title}");
                    
                    // Find the card element and test dragging
                    await JSRuntime.InvokeVoidAsync("eval", 
                        "const cards = document.querySelectorAll('[data-card-id]');" +
                        "if (cards.length > 0) {" +
                        "  console.log('üîç Found', cards.length, 'cards');" +
                        "  const firstCard = cards[0];" +
                        "  console.log('üîç First card:', firstCard);" +
                        "  console.log('üîç First card draggable:', firstCard.draggable);" +
                        "} else {" +
                        "  console.log('‚ùå No cards found in DOM');" +
                        "}");
                }
            }
            else
            {
                Console.WriteLine("‚ùå dragDrop object not found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Drag drop test failed: {ex.Message}");
        }
    }

    public void Dispose()
    {
        dotNetReference?.Dispose();
    }
}
